# 정산 시스템 및 대용량 데이터 처리 구현 방법

## 1. CashMember 도입

- [CashMember](src\01_CashMember\CashMember.java) : Cash 테이블에 있는 Member 관련 데이터를 별도의 CashMember 테이블로 분리하여 관리
- [CashMemberRepository](src\01_CashMember\CashMemberRepository.java) : CashMember 데이터 접근 및 관리
- [CashEventListener](src\01_CashMember\CashEventListener.java) : Member 관련 이벤트 발생 시 CashMember 업데이트 처리
- [CashFacade](src\01_CashMember\CashFacade.java) : CashMember와 Member 데이터 동기화

---

## 2. Wallet 도입 (CashWallet)

- [BaseManualIdAndTime](src\02_CashWallet\base\BaseManualIdAndTime.java) : 수동 ID 및 생성/수정 시간 관리를 위한 베이스 클래스
- [Wallet](src\02_CashWallet\Wallet.java) : CashMember와 1:1 관계인 지갑 생성
    - CashMember에 wallet 필드를 추가하지 않은 이유: 지갑은 추후 비관적인 락을 걸어서 가져와야 하는 경우가 있을 수 있기 때문에
- [WalletRepository](src\02_CashWallet\WalletRepository.java) : Wallet 데이터 접근 및 관리
- [CashEventListener](src\02_CashWallet\CashEventListener.java) : MemberJoinedEvent 발생 시 Wallet 생성 처리
- [CashFacade](src\02_CashWallet\CashFacade.java) : createWallet 메서드 추가

---

## 3. Cash 관련 데이터 초기화
- [Wallet](src\03_CashDataInit\Wallet.java) : Wallet에는 현재 상태인 balance 필드만 존재
- [CashLog](src\03_CashDataInit\CashLog.java) : Cash 변경 이력을 기록하는 CashLog 엔티티 추가
- [CashFacade](src\03_CashDataInit\CashFacade.java) : findMemberByUserName(), findWalletByHoder() 메서드 추가
- [CashDataInit](src\03_CashDataInit\CashDataInit.java) : Wallet 초기화
- [WalletRepository](src\03_CashDataInit\WalletRepository.java) : findByHolder() 메서드 추가

---

## 4. Cash 모듈 리팩토링

### Facade에 직접 구현된 기능들을 UseCase로 분리

* [CashFacade](src\04_Cash_Refactoring\CashFacade.java) : 구현로직 없이 유즈케이스 호출로 구성

* UseCase : 비즈니스 로직 구현
  * [CashCreateWalletUseCase](src\04_Cash_Refactoring\CashCreateWalletUseCase.java) : 지갑 생성 유즈케이스
  * [CashSyncMemberUseCase](src\04_Cash_Refactoring\CashSyncMemberUseCase.java) : 멤버 동기화 유즈케이스  

* [CashSupport](src\04_Cash_Refactoring\usecase\CashSupport.java) : UseCase에서 중복되는 코드인 findBy 메서드 모음

### CashEventListener에 있는 비지니스 로직을 이벤트를 사용하여 제거

- [CashMemberDto](src\04_Cash_Refactoring\CashMemberDto.java) : CashMember 관련 DTO
- [CashMemberCreatedEvent](src\04_Cash_Refactoring\CashMemberCreatedEvent.java) : CashMember 생성 이벤트
- [CashSyncMemberUseCase](src\04_Cash_Refactoring\CashSyncMemberUseCase.java) : CashMember 생성 후 CashMemberCreatedEvent 발행
- [CashEventListener](src\04_Cash_Refactoring\CashEventListener.java) : CashMemberCreatedEvent 리스너 추가
- [CashFacade](src\04_Cash_Refactoring\CashFacade.java) : CashMember를 CashMemberDto로 변환
- [CashCreateWalletUseCase](src\04_Cash_Refactoring\CashCreateWalletUseCase.java) : CashMemberCreatedEvent 수신 후 Wallet 생성

---

## 5. Post 모듈 리팩토링 - Facade에 직접 구현된 기능들을 UseCase로 분리

- [PostFacade](src\05_Post_Refactoring\PostFacade.java) : 구현로직 없이 유즈케이스 호출로 구성
- [PostSyncMemberUseCase](src\05_Post_Refactoring\PostSyncMemberUseCase.java) : Post 모듈에서 Member 동기화 유즈케이스
- [PostSupport](src\05_Post_Refactoring\PostSupport.java) : UseCase에서 중복되는 메서드 모음

---

## 6. Member 모듈 리팩토링 - Facade에 직접 구현된 기능들을 UseCase로 분리

- [MemberFacade](src\06_Member_Refactoring\MemberFacade.java) : 구현로직 없이 유즈케이스 호출로 구성
- [MemberGetRandomSecureTipUseCase](src\06_Member_Refactoring\MemberGetRandomSecureTipUseCase.java) : Member 모듈에서 랜덤 보안 팁 조회 유즈케이스
- [MemberSupport](src\06_Member_Refactoring\MemberSupport.java) : UseCase에서 중복되는 메서드 모음

---

## 7. Market 모듈 추가 - MarketMember 구현

- [MarketMember](src\07_MarketModule\MarketMember.java) : Market 모듈에서 Member 관련 데이터 관리
- [MarketMemberRepository](src\07_MarketModule\MarketMemberRepository.java) : MarketMember 데이터 접근 및 관리
- [MarketEventListener](src\07_MarketModule\MarketEventListener.java) : Member 관련 이벤트 발생 시 MarketMember 업데이트 처리
- [MarketFacade](src\07_MarketModule\MarketFacade.java) : MarketSyncMemberUseCase 호출
- [MarketSyncMemberUseCase](src\07_MarketModule\MarketSyncMemberUseCase.java) : Market 모듈에서 Member 동기화 유즈케이스

---

## 8. 글 조회를 위해서 PostApiClient 구현

- [PostApiClient](src\08_PostApiClient\PostApiClient.java) : Post 모듈의 글 조회 API 클라이언트
- [PostDto](src\08_PostApiClient\PostDto.java) : Post 모듈의 글 관련 DTO
- [PostFacade](src\08_PostApiClient\PostFacade.java) : findByOrderByIdDesc() 메서드 추가
- [PostSupport](src\08_PostApiClient\PostSupport.java) : findByOrderByIdDesc() 메서드 추가
- [PostRepository](src\08_PostApiClient\PostRepository.java) : findByOrderByIdDesc() 메서드 추가
- [MarketDataInit](src\08_PostApiClient\MarketDataInit.java) : Market 모듈에서 PostApiClient를 사용하여 글 데이터 초기화
- [ApiV1PostController](src\08_PostApiClient\ApiV1PostController.java) : 글 조회 API 구현

---

## 9. 글 6개로부터 상품 6개 생성

- [MarketDataInit](src\09_CreateMarketFromPost\MarketDataInit.java) : Market 모듈에서 PostApiClient를 사용하여 글 6개로부터 상품 6개 생성
- [Product](src\09_CreateMarketFromPost\Product.java) : Market 모듈의 상품 엔티티
- [ProductRepository](src\09_CreateMarketFromPost\ProductRepository.java) : Product 데이터 접근 및 관리
- [MarketFacade](src\09_CreateMarketFromPost\MarketFacade.java) : createProduct 메서드 추가
- [MarketCreateProductUseCase](src\09_CreateMarketFromPost\MarketCreateProductUseCase.java) : 글로부터 상품 생성 유즈케이스
- [MarketSupport](src\09_CreateMarketFromPost\MarketSupport.java) : 중복되는 메서드 모음

---

## 10. MarketMember와 1:1 관계인 장바구니 생성, 장바구니 품목 추가

[0033](https://github.com/jhs512/p-14116-1/commit/0033#diff-98dc624a0887f93a6a50a768265e924fef90ced30939a68d9e3b8b9cdb2b6352)


### 1단계: 회원 가입/수정 시 (외부 이벤트 수신)
1. **`MarketEventListener.handle(MemberJoinedEvent/MemberModifiedEvent)`**
   → Member 도메인에서 발생한 회원 가입/수정 이벤트를 수신하여 Market 도메인에 동기화 요청

2. **`MarketFacade.syncMember()`**
   → Market 도메인의 진입점으로, UseCase로 위임하는 파사드 역할

3. **`MarketSyncMemberUseCase.syncMember()`**
   → MemberDto를 MarketMember 엔티티로 변환 후 저장, 신규 회원이면 `MarketMemberCreatedEvent` 발행

### 2단계: MarketMember 생성 후 장바구니 자동 생성
4. **`MarketEventListener.handle(MarketMemberCreatedEvent)`**
   → MarketMember 생성 이벤트를 수신하여 장바구니 생성 요청

5. **`MarketFacade.createCart()`**
   → 장바구니 생성 UseCase로 위임

6. **`MarketCreateCartUseCase.createCart()`**
   → 해당 회원의 Cart 엔티티를 생성하고 저장

### 3단계: 애플리케이션 시작 시 초기 데이터 생성
7. **`MarketDataInit.makeBaseProducts()`**
   → ApplicationRunner로 실행되어 테스트용 상품 데이터 6개 생성


### 보조 클래스들
- **`MarketSupport`**: Repository 조회 로직을 모아둔 헬퍼 서비스
- **`Cart / CartItem`**: 장바구니와 장바구니 항목 엔티티
- **`CartRepository`**: Cart JPA 저장소 인터페이스
- **`MarketMemberDto`**: MarketMember를 다른 컨텍스트로 전달할 때 사용하는 DTO
- **`MarketMemberCreatedEvent`**: MarketMember 생성을 알리는 도메인 이벤트

---

## 11. 주문 생성

[0034](https://github.com/jhs512/p-14116-1/commit/0034#diff-09aad119f6df89c61db4d05e4d1c391963ed032e12027f7df170965fcd434a7b)

애플리케이션 시작 시 `MarketDataInit`의 `ApplicationRunner`가 실행되면서 다음 순서로 초기화가 진행돼요.

### 1단계: makeBaseProducts() - 상품 생성

```
MarketFacade.productsCount() 
  → MarketSupport.countProducts() 
    → ProductRepository.count()
```

상품이 없으면 `PostApiClient`에서 게시글을 가져와서 상품으로 등록해요.

```
MarketFacade.findMemberByUsername() → MarketSupport → MarketMemberRepository
MarketFacade.createProduct() → MarketCreateProductUseCase → ProductRepository.save()
```

### 2단계: makeBaseCartItems() - 장바구니에 상품 추가

```
MarketFacade.findMemberByUsername() → 회원 조회
MarketFacade.findCartByBuyer() → MarketSupport → CartRepository
MarketFacade.findProductById() → MarketSupport → ProductRepository
Cart.addItem() → CartItem 생성 후 리스트에 추가
```

### 3단계: makeBaseOrders() - 주문 생성

```
MarketFacade.ordersCount() → MarketSupport.countOrders() → OrderRepository.count()
MarketFacade.createOrder(cart) 
  → MarketCreateOrderUseCase.createOrder()
    → new Order(cart)  // Cart의 아이템들로 Order 생성
      → Order.addItem() → new OrderItem()
    → OrderRepository.save()
    → cart.clearItems()  // 장바구니 비우기
```
